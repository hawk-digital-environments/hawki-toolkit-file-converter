name: Release Pipeline

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  # ========================================================
  # JOB 1: Detect version and validate release requirement
  # ========================================================
  detect-version:
    name: Detect Version
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.should_release.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup release environment
        uses: ./.github/actions/setup-release-environment

      - name: Detect latest version from changelog
        id: version
        working-directory: .github/.release
        run: node detect-version.js

      - name: Check if new version should be released
        id: should_release
        if: steps.version.outputs.version != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git tag --list | grep -q "^${VERSION}$"; then
            echo "Tag ${VERSION} already exists. No new release needed."
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "New version ${VERSION} detected. Proceeding with release."
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

  # ========================================================
  # JOB 2: Test Docker build with caching (validate before release)
  # ========================================================
  test-docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    needs: detect-version
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test Docker build with caching
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: digitalenvironments/hawki-toolkit-file-converter:test
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ========================================================
  # JOB 3: Create release (only after successful build test)
  # ========================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [ detect-version, test-docker-build ]
    if: needs.detect-version.outputs.should_release == 'true'
    permissions:
      contents: write
    outputs:
      release_name: ${{ steps.create_release.outputs.release_name }}
      release_body: ${{ steps.create_release.outputs.release_body }}
      release_url: ${{ steps.create_release.outputs.release_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup release environment
        uses: ./.github/actions/setup-release-environment

      - name: Create git tag
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          git tag "$VERSION"
          git push origin "$VERSION"

      - name: Create GitHub release
        id: create_release
        working-directory: .github/.release
        run: node create-release.js "${{ needs.detect-version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================================
  # JOB 4: Build and push Docker image (using cache)
  # ========================================================
  build-and-publish-docker:
    name: Build & Publish Docker Image
    runs-on: ubuntu-latest
    needs: [ detect-version, create-release ]
    if: needs.detect-version.outputs.should_release == 'true'
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.detect-version.outputs.version }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v6.15.0
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            digitalenvironments/hawki-toolkit-file-converter:latest
            digitalenvironments/hawki-toolkit-file-converter:${{ steps.detect-version.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: index.docker.io/digitalenvironments/hawki-toolkit-file-converter
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  # ========================================================
  # JOB 5: Notify Discord
  # ========================================================
  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [ detect-version, create-release, build-and-publish-docker ]
    if: success() && needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup release environment
        uses: ./.github/actions/setup-release-environment

      - name: Send Discord Notification
        working-directory: .github/.release
        env:
          INPUT_WEBHOOK_URL: ${{ secrets.DISCORD_UPDATE_WEBHOOK_URL }}
          INPUT_RELEASE_NAME: ${{ needs.create-release.outputs.release_name }}
          INPUT_RELEASE_BODY: ${{ needs.create-release.outputs.release_body }}
          INPUT_RELEASE_URL: ${{ needs.create-release.outputs.release_url }}
          INPUT_CONTENT: "||@everyone|| Beware! a new **HAWKI File Converter** version just dropped **${{ needs.detect-version.outputs.version }}**!"
        run: node send-discord-notification.js
